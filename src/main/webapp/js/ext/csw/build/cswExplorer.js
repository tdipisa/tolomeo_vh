/*
 * Tolomeo is a developing framework for visualization, editing,
 * geoprocessing and decisional support application based on cartography.
 * 
 * Tolomeo Copyright 2011 Comune di Prato;
 * 
 * This file is part of Tolomeo.
 * 
 * Tolomeo is free software; you can redistribute it and/or modify 
 * it under the terms of the GNU Lesser General Public License 
 * as published by the Free Software Foundation; either version 3 of the License,
 *  or (at your option) any later version.
 * 
 * Tolomeo is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 *  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more details.
 * 
 * You should have received a copy of the GNU Lesser General Public License along with Tolomeo;
 *  if not, write to the Free Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110�1301  USA
 * 
 * Developers Information:
 * 
 * Tolomeo is developed by Comune di Prato
 * 
 * Alessandro Radaelli
 * Federico Nieri
 * Mattia Gennari
 * 
 * sit@comune.prato.it
 *  
 * 
 * Versione in Italiano LGPL
 * 
 * Tolomeo � un framework per lo sviluppo di applicazioni per
 * visualizzazione, editing, geoprocessing e supporto alla decisione basate su cartografia.
 * 
 * Tolomeo Copyright 2011 Comune di Prato;
 * 
 * Questo file fa parte di Tolomeo.
 * 
 * Tolomeo � un software libero; � possibile redistribuirlo e / o
 *  modificarlo sotto i termini della GNU Lesser General Public License,
 *  come pubblicato dalla Free Software Foundation, sia la versione 3 della licenza o (a propria scelta) una versione successiva.
 * 
 * Tolomeo � distribuito nella speranza che possa essere utile,
 * ma SENZA ALCUNA GARANZIA, senza neppure la garanzia implicita di COMMERCIABILIT� o
 * IDONEIT� PER UN PARTICOLARE SCOPO. Vedere la GNU Lesser General Public License per ulteriori dettagli.
 * 
 * Si dovrebbe avere ricevuto una copia della GNU Lesser General Public insieme a Tolomeo, in caso contrario,
 *  si scriva alla Free Software  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110�1301 USA
 * 
 * 
 * Informazioni Sviluppatori:
 * 
 * Tolomeo � sviluppato dal Comune di Prato
 * 
 * Alessandro Radaelli
 * Federico Nieri
 * Mattia Gennari
 * 
 * sit@comune.prato.it
 */
var isDCValidName=function(a){if(a=="abstract"){return true}if(a=="creator"){return true}if(a=="contributor"){return true}if(a=="subject"){return true}if(a=="description"){return true}if(a=="publisher"){return true}if(a=="date"){return true}if(a=="type"){return true}if(a=="format"){return true}if(a=="identifier"){return true}if(a=="source"){return true}if(a=="language"){return true}if(a=="relation"){return true}if(a=="coverage"){return true}if(a=="rights"){return true}return false};var CSW2ExtConvert=function(c,b){if(this.name=="thumbnail"){var g;var f=b.raw.URI;if(!f){return}for(var e=0;e<f.length;e++){if(f[e].name=="thumbnail"){g=f[e]}}return g}else{if(this.name=="map"){var g=new Array();var f=b.raw.URI;if(!f){return g}for(var e=0;e<f.length;e++){if(f[e].protocol=="OGC:WMS-1.1.1-http-get-map"||f[e].protocol=="OGC:WMS-1.3.0-http-get-map"){g.push(f[e])}}return g}else{if(this.name=="downloads"){var g=new Array();var f=b.raw.URI;if(!f){return g}for(var e=0;e<f.length;e++){if(f[e].protocol=="WWW:DOWNLOAD-1.0-http--download"){g.push(f[e])}}return g}else{if(this.name=="dc"){var a=new Array();for(el in b.raw){if(isDCValidName(el)){a[el]=b.raw[el]}}return a}else{if(b.raw[this.name]){if(b.raw[this.name] instanceof Array){if(b.raw[this.name].length==1){return b.raw[this.name][0].value?b.raw[this.name][0].value:b.raw[this.name][0]}else{var d=new Array();for(var e=0;e<b.raw[this.name].length;e++){d.push(b.raw[this.name][e].value)}return d}}else{return b.raw[this.name]}}else{return undefined}}}}}};var CSWRecord=Ext.define("CSWRecord",{extend:"Ext.data.Model",fields:[{name:"dc",convert:CSW2ExtConvert},{name:"title",convert:CSW2ExtConvert},{name:"creator",convert:CSW2ExtConvert},{name:"subject",convert:CSW2ExtConvert},{name:"description",convert:CSW2ExtConvert},{name:"abstract",convert:CSW2ExtConvert},{name:"publisher",convert:CSW2ExtConvert},{name:"contributor",convert:CSW2ExtConvert},{name:"date",convert:CSW2ExtConvert},{name:"type",convert:CSW2ExtConvert},{name:"format",convert:CSW2ExtConvert},{name:"identifier",convert:CSW2ExtConvert},{name:"source",convert:CSW2ExtConvert},{name:"language",convert:CSW2ExtConvert},{name:"relation",convert:CSW2ExtConvert},{name:"coverage",convert:CSW2ExtConvert},{name:"bounds"},{name:"rights",convert:CSW2ExtConvert},{name:"projection"},{name:"thumbnail",convert:CSW2ExtConvert},{name:"map",convert:CSW2ExtConvert},{name:"absolutePath"},{name:"downloads",convert:CSW2ExtConvert}]});Ext.define("CSWRecordsReader",{extend:"Ext.data.JsonReader",store:null,constructor:function(a){if(!a.format){a.format=new OpenLayers.Format.CSWGetRecords()}if(!a.root){a.root="records"}a.totalProperty="SearchResults.numberOfRecordsMatched";this.callParent(arguments)},read:function(a){var b=a.responseXML;if(!b||!b.documentElement){b=a.responseText}return this.readRecords(b)},readRecords:function(a){if(typeof a==="string"||a.nodeType){a=this.format.read(a)}a.total=a.SearchResults.numberOfRecordsMatched;return this.callParent(arguments)}});Ext.define("CSWHttpProxy",{extend:"Ext.data.proxy.Ajax",resultType:null,filterVersion:null,cswVersion:null,filter:null,XDProxy:null,sortProperty:null,sortOrder:null,constructor:function(a){this.cswVersion=(a.cswVersion)?a.cswVersion:"2.0.2";this.sortProperty=(a.sortProperty)?a.sortProperty:"Title";this.sortOrder=(a.sortOrder)?a.sortOrder:"ASC";this.limit=a.limit;a.currentCatalog=a.url;if(a.XDProxy){if(a.XDProxy.callback){a.url=a.XDProxy.url+"?"+a.XDProxy.callback+"="+encodeURIComponent(a.url)}else{a.url=a.XDProxy.url+"?"+a.url}}a.method="POST";a.extraParams={Request:"GetRecords",Service:"CSW"};a.xmlData=this.buildCSWRequestData(a);this.callParent(arguments)},updateRequest:function(b,a){this.xmlData=this.buildCSWRequestData(b,a)},buildCSWRequestData:function(c,b){this.resultType=(c.resultType)?c.resultType:this.resultType;this.filterVersion=(c.filterVersion)?c.filterVersion:this.filterVersion;this.filter=(c.filter)?c.filter:this.filter;this.currentCatalog=(c.url)?c.url:this.currentCatalog;this.sortProperty=(c.sortProperty)?c.sortProperty:this.sortProperty;this.sortOrder=(c.sortOrder)?c.sortOrder:this.sortOrder;var d;if(b){d=b.start?b.start:1}else{d=c.start?c.start:1}var e={url:(c.XDProxy?c.XDProxy.url+"?"+c.XDProxy.callback+"="+c.url:c.url),resultType:"results",startPosition:d,maxRecords:(this.limit?this.limit:10),outputFormat:"application/xml",outputSchema:"http://www.opengis.net/cat/csw/"+this.cswVersion};if(this.filter!=null&&!c.emptySearch){e.Query={ElementSetName:{value:this.resultType},Constraint:{version:this.filterVersion,Filter:this.filter}}}else{e.Query={ElementSetName:{value:this.resultType}}}e.Query.SortBy={SortProperty:{PropertyName:{value:this.sortProperty},SortOrder:{value:this.sortOrder}}};var f=new OpenLayers.Format.CSWGetRecords();var a=f.write(e);a=a.replace('xmlns:NS1=""',"");a=a.replace("NS1:","");return a},doRequest:function(a,e,b){var d=this.getWriter(),c=this.buildRequest(a,e,b);if(a.allowWrite()){c=d.write(c)}Ext.apply(c,{xmlData:this.xmlData,headers:this.headers,timeout:this.timeout,scope:this,callback:this.createRequestCallback(c,a,e,b),method:"POST",disableCaching:false});Ext.Ajax.request(c);return c}});Ext.define("CSWGrid",{extend:"Ext.grid.GridPanel",config:null,border:false,enableHdMenu:false,height:290,autoScroll:true,title:null,iconCls:"icon-grid",autoExpandColumn:"title",i18n:null,constructor:function(a){var b=this;var c={ptype:"rowexpander",rowBodyTpl:new Ext.XTemplate('<tpl if="thumbnail"><img src="{absolutePath}/{thumbnail.value}" class="csw-viewer-thumb" style="" alt="{thumbnail.description}" 	type="{thumbnail.protocol}" ></tpl><p><b>'+a.i18n.getMsg("abstract")+": </b>{abstract}</p><p><b>"+a.i18n.getMsg("subject")+": </b>{subject}</p>")};a.plugins=[c];this.callParent(arguments)},initComponent:function(){this.title=this.i18n.getMsg("titleCatalogRecords");var a=this;this.columns={defaults:{sortable:false},items:[{xtype:"actioncolumn",width:75,items:[{iconCls:"icon-info",tooltip:this.i18n.getMsg("viewMetadata"),handler:function(b,i,k){var f=b.getStore().getAt(i);var m=f.get("dc");var h=f.get("identifier");var j=f.get("absolutePath");if(h){window.open(j.substring(0,j.length-3)+"metadata.show?uuid="+h)}else{var l="<ul>";for(var d in m){if(m[d] instanceof Array){for(var g=0;g<m[d].length;g++){if(m[d][g].value){l+="<li><strong>"+d+":</strong> ";for(name in m[d][g]){l+="<strong>"+name+"</strong>="+m[d][g][name]+" "}l+="</li>"}else{if(d=="abstract"){l+="<li><strong>abstract:</strong> "+m[d][g]+"</li> "}else{true}}}}}m+="</ul>";var e=new Ext.Panel({html:l,preventBodyReset:true,autoScroll:true,autoHeight:false,width:600,height:400});var c=new Ext.Window({title:"MetaData",closable:true,width:614,resizable:false,draggable:true,items:[e]});c.show()}}},{iconCls:"icon-layers",tooltip:this.i18n.getMsg("viewMap"),handler:function(b,g,j){var d=b.getStore().getAt(g);var c=d.get("map");var f=d.get("bounds");var h=new Array();for(var e=0;e<c.length;e++){h.push({wms:c[e].value,layer:c[e].name,description:c[e].description})}var i={title:d.get("title"),crs:d.get("projection"),layers:h,bbox:d.get("bounds"),uuid:d.get("identifier"),gnURL:d.get("absolutePath").substring(0,d.get("absolutePath").length-3)};b.findParentByType("csw").fireEvent("ViewMap",i)},isDisabled:function(d,g,e,f,c){var b=c.get("map");return !(b&&b.length>0)}},{iconCls:"icon-mapgo",tooltip:this.i18n.getMsg("viewBbox"),handler:function(d,f,c){var e=d.getStore().getAt(f);var b={bbox:e.get("bounds"),crs:e.get("projection")};d.findParentByType("csw").fireEvent("zoomToExtent",b)}},{iconCls:"icon-mapgo",tooltip:this.i18n.getMsg("download"),handler:function(b,l,m,o,k,h){var d=b.getStore().getAt(l);var j=d.get("downloads");var n="";var g=[];for(var f=0;f<j.length;f++){g.push({text:j[f].name,urlToOpen:j[f].value,listeners:{click:{fn:function(){window.open(this.urlToOpen)}}}})}var c=Ext.create("Ext.menu.Menu",{items:g});c.showAt(k.getXY())},isDisabled:function(d,g,e,f,c){var b=c.get("downloads");return !(b instanceof Array)}}]},{text:this.i18n.getMsg("title"),dataIndex:"title",sortable:false,flex:1},{text:this.i18n.getMsg("subject"),dataIndex:"subject",sortable:false},{text:this.i18n.getMsg("modified"),dataIndex:"date",sortable:false}]};this.viewConfig={forceFit:true};this.store=new Ext.data.Store({model:CSWRecord,pageSize:this.config.limit,autoLoad:false});this.dockedItems=[{xtype:"pagingtoolbar",store:this.store,dock:"bottom",displayInfo:true}];this.callParent(arguments);this.reconfigure()},initParameters:function(a){a.XDProxy=this.config.XDProxy;a.cswVersion=this.config.cswVersion;a.limit=this.config.limit;a.timeout=this.config.timeout;a.reader=Ext.create("CSWRecordsReader",{});a.model=CSWRecord;this.store.proxy=new CSWHttpProxy(a);this.store.proxy.on("exception",function(f,e,g,d,b,c){if(e=="remote"){Ext.Msg.show({title:this.i18n.getMsg("serverError.title"),msg:this.i18n.getMsg("serverError.serverError.invalid"),buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR})}else{if(e=="response"){if(!c&&b.isTimeout&&b.isTimeout==true){Ext.Msg.show({title:this.i18n.getMsg("timeout.title"),msg:this.i18n.getMsg("timeout.description"),buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR})}else{if(!c){Ext.Msg.show({title:this.i18n.getMsg("serverError.title"),msg:this.i18n.getMsg("serverError.invalid")+":"+b.status+" "+b.statusText,buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR})}else{Ext.Msg.show({title:this.i18n.getMsg("serverError.title"),msg:this.i18n.getMsg("serverError.catalogException"),buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR})}}}}this.store.fireEvent("loadexception")},this);this.store.on("beforeload",function(c,b,d){c.proxy.updateRequest(b)},this);this.store.on("load",function(d,c,f){if(c){var e=d.proxy.currentCatalog;for(var g=0;g<c.length;g++){var b;c[g].set("absolutePath",e);if(b=c[g].get("thumbnail")){var h=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;if(!h.test(b.value)){b.value=e+"/"+b.value}c[g].set("thumbnail",b)}}}},this);this.enable();this.store.load(a.params)}});Ext.define("CSWCatalogChooser",{extend:"Ext.form.ComboBox",border:false,labelWitdh:30,name:"catalog",allowBlank:true,disabled:false,fieldLabel:null,emptyText:null,mode:"local",triggerAction:"all",forceSelection:true,displayField:"name",valueField:"url",editable:false,resizable:false,i18n:null,initComponent:function(){this.addEvents("selectsupported");this.addEvents("selectunsupported");this.addEvents("selectiunknownsupport");this.listeners={select:{fn:this.selectListener}};this.callParent(arguments)},initParameters:function(a){this.store=new Ext.data.JsonStore({proxy:{type:"memory"},mode:"local",data:a,autoLoad:true,remoteSort:false,fields:["name","url","description"],sortInfo:{field:"name",direction:"ASC"}});this.addEvents(this.events)},selectListener:function(f,b,e){var a=b[0].data.url;var d="";var c=a+"?Request=GetCapabilities&SERVICE=CSW&Section=ServiceIdentification&outputformat=application/xml&AcceptVersions="+this.cswVersion;if(this.XDProxy){if(this.XDProxy){if(this.XDProxy.callback){d=this.XDProxy.url+"?"+this.XDProxy.callback+"="+encodeURIComponent(c)}else{d=this.XDProxy.url+"?"+c}}}Ext.Ajax.request({url:d,scope:this,method:"GET",timeout:10000,success:function(g,h){if(g.responseText.indexOf("ows:ExceptionReport")>0){if(g.responseText.indexOf("VersionNegotiationFailed")>0){Ext.Msg.show({title:this.i18n.getMsg("serverError.catalogCompatibilityProblem"),msg:this.i18n.getMsg("serverError.unsupportedVersion")+"("+this.cswVersion+")",width:300,icon:Ext.MessageBox.ERROR});f.fireEvent("selectunsupported",this.i18n.getMsg("serverError.unsupportedVersion")+"("+this.cswVersion+")")}else{if(g.responseText.indexOf("InvalidParameterValue")>0&&g.responseText.indexOf('locator="service"')){Ext.Msg.show({title:this.i18n.getMsg("serverError.catalogCompatibilityProblem"),msg:this.i18n.getMsg("serverError.CSWNotAvaible"),width:300,icon:Ext.MessageBox.ERROR});f.fireEvent("selectunsupported",this.i18n.getMsg("serverError.CSWNotAvaible"))}else{if(g.responseText.indexOf('exceptionCode="NoApplicableCode"')){Ext.Msg.show({title:this.i18n.getMsg("serverError.compatibilityInfo"),msg:this.i18n.getMsg("serverError.unableToTestCapabilities"),width:300,icon:Ext.MessageBox.WARNING});f.fireEvent("selectiunknownsupport",this.i18n.getMsg("serverError.unableToTestCapabilities"))}}}}else{if(!(g.responseText.indexOf("csw:Capabilities")>0)){Ext.Msg.show({title:this.i18n.getMsg("serverError.standardCompatibility"),msg:this.i18n.getMsg("serverError.unknownResponse"),width:300,icon:Ext.MessageBox.ERROR});f.fireEvent("selectunsupported",this.i18n.getMsg("serverError.unknownResponse"))}else{var i=b[0].data.description;f.fireEvent("selectsupported",i)}}},failure:function(g,h){if(g.isTimeout&&g.isTimeout==true){Ext.Msg.show({title:this.i18n.getMsg("timeout.title"),msg:this.i18n.getMsg("timeout.description"),buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR});f.fireEvent("selectunsupported")}else{Ext.Msg.alert(this.i18n.getMsg("serverError.title"),this.i18n.getMsg("serverError.invalid")+"<br/> Status:"+g.status);f.fireEvent("selectunsupported",this.i18n.getMsg("serverError.invalid")+"<br/> Status:"+g.status)}}})}});Ext.define("CSWSearchTool",{extend:"Ext.form.FormPanel",border:false,autoWidth:true,dateFormat:"Y-m-d",dcProperty:null,filterVersion:null,buttonAlign:"center",i18n:null,advancedSearchSet:null,basicSearchSet:null,catalogChooser:null,searchButton:null,freeText:null,lastModifiedBegin:null,lastModifiedEnd:null,useBox:null,dcValue:null,panel:null,mask:null,autoHeight:true,initParameters:function(a){this.catalogChooser.initParameters(a)},search:function(d){if(this.fireEvent("beforesearch",d)===false){return}var c=new Array();if(d.freeText!=""){var b=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LIKE,property:"apiso:AnyText",value:d.freeText});c.push(b)}if(d.useAdvancedSearch){if(d.dcValue!=""){var b=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:this.dcProperty,matchCase:false,value:d.dcValue});c.push(b)}if(d.useBbox==true){var b=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Spatial.BBOX,property:"ows:BoundingBox",value:this.bbox});c.push(b)}if(d.lastModifiedBegin&&d.lastModifiedBegin!=""){var b=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO,property:"tempExtentBegin",value:d.lastModifiedBegin.format(this.dateFormat)+"T00:00:00Z"});c.push(b)}if(d.lastModifiedEnd&&d.lastModifiedEnd!=""){var b=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO,property:"tempExtentEnd",value:d.lastModifiedEnd.format(this.dateFormat)+"T23:59:59Z"});c.push(b)}}var a={url:this.catalogChooser.getValue(),filterVersion:this.filterVersion,resultType:"full"};if(c.length!=0){a.filter=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:c});a.emptySearch=false}else{a.emptySearch=true}this.resetButton.disable();this.searchButton.disable();this.catalogChooser.disable();this.panel.cswGrid.store.on("load",function(){this.resetButton.enable();this.searchButton.enable();this.catalogChooser.enable()},this);this.panel.cswGrid.store.on("loadexception",function(){this.resetButton.enable();this.searchButton.enable();this.catalogChooser.enable()},this);this.panel.cswGrid.initParameters(a)},initComponent:function(){this.addEvents({beforesearch:true});this.catalogChooser=Ext.create("CSWCatalogChooser",{XDProxy:this.panel.config.XDProxy,i18n:this.i18n,cswVersion:this.panel.config.cswVersion,fieldLabel:this.i18n.getMsg("catalogField"),emptyText:this.i18n.getMsg("catalogEmptyText"),labelStyle:"width: 150px",width:400});this.catalogDescriptionPanel=new Ext.Panel({xtype:"panel",id:"suggestintropan",header:false,width:350,autoHeight:true,border:false,collapsible:true,collapsed:true,collapseMode:"mini",hideCollapseTool:true});this.searchButton=new Ext.Button({text:this.i18n.getMsg("search"),scope:this,iconCls:"icon-search",tooltip:this.i18n.getMsg("searchTooltip"),handler:function(){this.search({freeText:this.freeText.getValue(),lastModifiedBegin:this.lastModifiedBegin.getValue(),lastModifiedEnd:this.lastModifiedEnd.getValue(),useBbox:this.useBbox.getValue(),dcValue:this.dcValue.getValue(),useAdvancedSearch:!this.advancedSearchSet.collapsed})}});this.resetButton=new Ext.Button({text:this.i18n.getMsg("reset"),iconCls:"icon-reset",tooltip:this.i18n.getMsg("resetTooltip"),scope:this,handler:function(){this.getForm().reset();this.searchButton.disable();this.resetButton.disable();this.advancedSearchSet.collapse(true);this.lastModifiedEnd.setMinValue();this.lastModifiedBegin.setMaxValue();this.panel.cswGrid.getStore().removeAll();this.catalogDescriptionPanel.update("");this.catalogDescriptionPanel.collapse()}});this.catalogSelectionPan=new Ext.form.FieldSet({title:this.i18n.getMsg("catalogSelection"),autoHeight:true,collapsed:false,collapsible:false,padding:5,defaults:{labelStyle:"width: 150px",width:200},items:[this.catalogChooser,this.catalogDescriptionPanel]});this.freeText=new Ext.form.TextField({fieldLabel:this.i18n.getMsg("freeText"),labelStyle:"width: 150px",width:400,emptyText:this.i18n.getMsg("anyText"),enableKeyEvents:true,listeners:{scope:this,keydown:function(a,b){if(b.getKey()==13&&this.catalogChooser.getValue()){this.searchButton.handler.call(this.searchButton.scope,this.searchButton.searchButton)}}}});this.lastModifiedBegin=new Ext.form.DateField({fieldLabel:this.i18n.getMsg("modifiedbegin"),width:100,format:this.dateFormat,editable:false,labelStyle:"width: 140px",listeners:{scope:this,change:function(b,a){this.lastModifiedEnd.setMinValue(a)}}});this.lastModifiedEnd=new Ext.form.DateField({fieldLabel:this.i18n.getMsg("modifiedend"),width:100,format:this.dateFormat,editable:false,labelStyle:"width: 140px",listeners:{scope:this,change:function(b,a){this.lastModifiedBegin.setMaxValue(a)}}});this.useBbox=new Ext.form.Checkbox({fieldLabel:this.i18n.getMsg("mapExtent"),labelStyle:"width: 140px"});this.dcValue=new Ext.form.TextField({labelStyle:"width: 140px",width:200,fieldLabel:this.i18n.getMsg("dcProperty"+this.dcProperty)});this.advancedSearchSet=new Ext.form.FieldSet({checkboxToggle:true,title:this.i18n.getMsg("advancedSearchSet"),autoHeight:true,collapsed:true,layout:{type:"table",columns:2},items:[{layout:"form",border:false,colspan:1,width:320,items:[this.lastModifiedBegin]},{layout:"form",border:false,colspan:1,style:"position:relative;top:-2px;",items:[new Ext.Button({iconCls:"icon-reset",tooltip:this.i18n.getMsg("clearDateBegin"),scope:this,handler:function(){this.lastModifiedBegin.reset();this.lastModifiedEnd.setMinValue()}})]},{layout:"form",border:false,colspan:1,width:320,items:[this.lastModifiedEnd]},{layout:"form",border:false,colspan:1,style:"position:relative;top:-2px;",items:[new Ext.Button({iconCls:"icon-reset",tooltip:this.i18n.getMsg("clearDateEnd"),scope:this,handler:function(){this.lastModifiedEnd.reset();this.lastModifiedBegin.setMaxValue()}})]},{layout:"form",border:false,colspan:2,width:345,items:[this.useBbox]},{layout:"form",border:false,colspan:2,width:345,items:[this.dcValue]}]});this.SearchSet=new Ext.form.FieldSet({title:this.i18n.getMsg("basicSearchSet"),autoHeight:true,collapsed:false,collapsible:false,items:[this.freeText,this.advancedSearchSet]});this.items=[this.catalogSelectionPan,this.SearchSet];this.buttons=[this.searchButton,this.resetButton];this.searchButton.disable();this.resetButton.disable();this.catalogChooser.on("select",function(){this.searchButton.disable();this.resetButton.disable();this.mask=new Ext.LoadMask(this.el,{msg:this.i18n.getMsg("getCapabilitiesWait")});this.mask.show()},this);this.catalogChooser.on("selectsupported",function(a){this.searchButton.enable();this.resetButton.enable();this.mask.hide();this.mask=null;a='<div class="catalog-desc-ok">'+a+"</div>";this.catalogDescriptionPanel.update(a);this.catalogDescriptionPanel.expand();this.panel.setSize(this.panel.width-31,this.panel.getHeight)},this);this.catalogChooser.on("selectunsupported",function(a){this.searchButton.disable();this.resetButton.disable();this.mask.hide();this.mask=null;var a='<div class="catalog-desc-error" /><div>'+a+"</div>";this.catalogDescriptionPanel.update(a);this.catalogDescriptionPanel.expand();this.panel.setSize(this.panel.width-31,this.panel.getHeight)},this);this.catalogChooser.on("selectiunknownsupport",function(a){this.searchButton.enable();this.resetButton.enable();this.mask.hide();this.mask=null;var a='<div class="catalog-desc-warning">'+a+"</div>";this.catalogDescriptionPanel.update(a);this.catalogDescriptionPanel.expand();this.panel.setSize(this.panel.width-31,this.panel.getHeight)},this);this.callParent(arguments)}});Ext.define("CSWPanel",{extend:"Ext.Panel",alias:"widget.csw",border:false,title:"CSW Explorer",iconCls:"icon-table",map:null,config:null,events:["zoomToExtent","viewMap","beforesearch"],autoWidth:true,autoHeight:true,border:false,searchTool:null,cswGrid:null,i18n:null,initComponent:function(){this.cswGrid=new CSWGrid({loadMask:{msg:this.i18n.getMsg("loadWait")},config:this.config,i18n:this.i18n,map:new Ext.KeyMap(document,[{key:Ext.EventObject.ESC,fn:function(){if(this.cswGrid.store.proxy){this.cswGrid.store.proxy.getConnection().abort();this.cswGrid.loadMask.hide();this.searchTool.resetButton.enable();this.searchTool.searchButton.enable();this.searchTool.catalogChooser.enable()}},scope:this}])});this.searchTool=new CSWSearchTool({grid:this.cswGrid,dcProperty:this.config.dcProperty,panel:this,autoHeight:true,style:"margin-left:5px;margin-right:5px;",bbox:new OpenLayers.Bounds(this.config.initialBBox.minx,this.config.initialBBox.miny,this.config.initialBBox.maxx,this.config.initialBBox.maxy),filterVersion:this.config.filterVersion,i18n:this.i18n});this.items=[{xtype:"container",layout:"fit",autoHeight:true,border:false,items:[this.searchTool]},{xtype:"container",layout:"fit",autoWidth:true,border:false,items:[this.cswGrid]}];this.addEvents(this.events);this.initParameters(this.config.catalogs);this.callParent(arguments);this.relayEvents(this.searchTool,["beforesearch"])},initParameters:function(b){this.searchTool.initParameters(b);var a=this.cswGrid.store;this.searchTool.catalogChooser.addListener("select",function(){a.removeAll();a.catalogUrl=this.getValue()});this.searchTool.panel=this},setBBox:function(a){if(a==null){return}this.searchTool.bbox=new OpenLayers.Bounds(a.minx,a.miny,a.maxx,a.maxy)}});Ext.define("CSWPagingToolbar",{extend:"Ext.PagingToolbar",autoWidth:true,i18n:null,initComponent:function(){this.paramNames={start:"start",limit:"limit"};this.callParent(arguments);this.expandAll=this.add({text:this.i18n.getMsg("expandAll"),scope:this,iconCls:"icon-expand-all",disabled:true,tooltip:this.i18n.getMsg("expandTooltip"),handler:function(){this.grid.plugins.expandAll()}});this.collapseAll=this.add({text:this.i18n.getMsg("collapseAll"),scope:this,iconCls:"icon-collapse-all",disabled:true,tooltip:this.i18n.getMsg("collapseTooltip"),handler:function(){this.grid.plugins.collapseAll()}})},doLoad:function(c){var b={},a=this.getParams();b[a.start]=c+1;b[a.limit]=this.pageSize;b.jsonData={};if(this.fireEvent("beforechange",this,b)!==false){this.store.reload({params:b})}},onLoad:function(a,e,i){if(!this.rendered){this.dsLoaded=[a,e,i];return}var f=this.getParams();this.cursor=(i.params&&i.params[f.start])?i.params[f.start]-1:0;var h=this.getPageData(),b=h.activePage,g=h.pages;var c=this.store.getCount();this.afterTextItem.setText(String.format(this.afterPageText,h.pages));this.inputItem.setValue(b);this.first.setDisabled(b==1);this.prev.setDisabled(b==1);this.next.setDisabled(b==g);this.last.setDisabled(b==g);this.expandAll.setDisabled(!c);this.collapseAll.setDisabled(!c);this.refresh.setDisabled(!c);this.inputItem.setDisabled(!c);this.updateInfo();this.fireEvent("change",this,h)},onClear:function(a,c){this.cursor=0;var d=this.getParams();var b=0,e=1;this.afterTextItem.setText(String.format(this.afterPageText,e));this.inputItem.setValue(b);this.first.setDisabled(true);this.prev.setDisabled(true);this.next.setDisabled(true);this.last.setDisabled(true);this.expandAll.setDisabled(true);this.collapseAll.setDisabled(true);this.refresh.setDisabled(true);this.inputItem.setDisabled(true);this.updateInfo()}});